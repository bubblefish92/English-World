<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’å‹•å¼æ•¸ä½æ‹¼åœ–éŠæˆ²</title>
    <style>
        :root {
            --primary-color: #FF9F1C; /* äº®æ©˜è‰² */
            --secondary-color: #2EC4B6; /* è—ç¶ è‰² */
            --bg-color: #FFFFFF;
            --text-color: #333;
            --gap-size: 2px;
            --rows: 4;
            --cols: 4;
            --aspect-ratio: 1 / 1;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­—å¹²æ“¾æ‹–æ›³ */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* 2. è¦–è¦ºæ¨£å¼è¨­è¨ˆï¼šå…¨é èƒŒæ™¯æµ®æ°´å° */
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.ibb.co/fVXG8mD0/14602771.webp');
            background-repeat: repeat;
            background-size: cover;
            opacity: 0.5;
            z-index: -1;
            pointer-events: none;
        }

        h1 {
            color: var(--primary-color);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            text-align: center;
            font-size: 2rem;
        }

        /* æ§åˆ¶å€æ¨£å¼ */
        .controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            width: 100%;
            max-width: 600px;
        }

        select, button, .file-upload-label {
            padding: 10px 15px;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            background: white;
            color: var(--secondary-color);
            transition: all 0.2s;
            font-weight: bold;
        }

        button:hover, select:hover, .file-upload-label:hover {
            background: var(--secondary-color);
            color: white;
        }

        button:active {
            transform: scale(0.95);
        }

        /* éš±è—åŸç”Ÿæª”æ¡ˆä¸Šå‚³ input */
        input[type="file"] {
            display: none;
        }

        /* éŠæˆ²å®¹å™¨ */
        .game-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }

        /* æ‹¼åœ–æ¿ï¼šæ ¸å¿ƒä½ˆå±€ */
        #puzzle-board {
            width: 100%;
            aspect-ratio: var(--aspect-ratio);
            display: grid;
            grid-template-columns: repeat(var(--cols), 1fr);
            grid-template-rows: repeat(var(--rows), 1fr);
            gap: var(--gap-size);
            background-color: #ddd;
            border: 2px solid var(--secondary-color);
            position: relative;
            overflow: hidden;
        }

        /* å·çœ‹æ¨¡å¼ï¼šç›´æ¥åœ¨ board ä¸Šé¡¯ç¤ºåŸåœ– */
        #puzzle-board.peeking {
            background-image: var(--bg-image);
            background-size: 100% 100%;
            background-position: center;
        }
        
        #puzzle-board.peeking .piece {
            opacity: 0; /* éš±è—æ‹¼åœ–å¡Š */
            pointer-events: none;
        }

        /* æ‹¼åœ–å¡Šæ¨£å¼ */
        .piece {
            width: 100%;
            height: 100%;
            background-image: var(--bg-image);
            /* é—œéµï¼šè¨ˆç®—èƒŒæ™¯å¤§å°ä»¥ç¬¦åˆæ•´å€‹å®¹å™¨ */
            background-size: calc(var(--cols) * 100% + (var(--cols) - 1) * var(--gap-size)) 
                             calc(var(--rows) * 100% + (var(--rows) - 1) * var(--gap-size));
            background-position: var(--pos-x) var(--pos-y);
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            border-radius: 4px;
            position: relative;
        }

        .piece:active {
            cursor: grabbing;
        }

        /* é»é¸é¸å–æ¨£å¼ */
        .piece.selected {
            z-index: 10;
            box-shadow: 0 0 0 3px var(--primary-color), 0 0 10px rgba(255, 159, 28, 0.5);
            transform: scale(0.95);
            border-color: var(--primary-color);
        }

        /* æ‹–æ›³æ™‚çš„ç›®æ¨™æ¨£å¼ */
        .piece.drag-over {
            opacity: 0.6;
            box-shadow: inset 0 0 0 4px var(--primary-color);
        }

        /* å‹åˆ© Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border-top: 10px solid var(--primary-color);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 {
            color: var(--primary-color);
            margin-top: 0;
        }

        .modal p {
            font-size: 1.2rem;
            color: #555;
            margin: 20px 0;
        }

        .modal-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 25px;
            box-shadow: 0 4px 0 #d6830e;
        }
        
        .modal-btn:hover {
            background: #ffae42;
        }

        .modal-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #d6830e;
        }

        /* RWD èª¿æ•´ */
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .controls { padding: 10px; }
            button, select { font-size: 0.9rem; padding: 8px 12px; }
        }

    </style>
</head>
<body>

    <h1>ğŸ§© äº’å‹•å¼æ•¸ä½æ‹¼åœ–</h1>

    <!-- æ§åˆ¶å€ -->
    <div class="controls">
        <!-- é—œå¡é¸æ“‡ -->
        <select id="level-select">
            <option value="https://i.ibb.co/JR14WNs3/6272f22e-01e5-4814-9a0b-836a148ec340.webp">ğŸ¶ é è¨­é—œå¡ 1 (å¯æ„›ç‹—ç‹—)</option>
            <option value="https://i.ibb.co/YBszrdZM/upload-2025-11-28-1153231.jpg">ğŸï¸ é è¨­é—œå¡ 2 (é¢¨æ™¯)</option>
        </select>

        <!-- è‡ªè¨‚ä¸Šå‚³ -->
        <label class="file-upload-label">
            ğŸ“ ä¸Šå‚³åœ–ç‰‡
            <input type="file" id="image-upload" accept="image/*">
        </label>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <button id="restart-btn">ğŸ”„ é‡æ–°é–‹å§‹</button>
        <!-- å·çœ‹æŒ‰éˆ• (é›»è…¦æŒ‰ä½ï¼Œæ‰‹æ©Ÿé»æ“Šåˆ‡æ›) -->
        <button id="peek-btn">ğŸ‘€ å·çœ‹åŸåœ–</button>
    </div>

    <!-- éŠæˆ²å€ -->
    <div class="game-container">
        <div id="puzzle-board">
            <!-- æ‹¼åœ–å¡Šå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å‹åˆ©è¦–çª— -->
    <div class="modal-overlay" id="win-modal">
        <div class="modal">
            <h2>ğŸ‰ æ­å–œå®Œæˆï¼</h2>
            <p>ä½ çœŸæ£’ï¼æˆåŠŸæ‹¼å‡ºäº†å®Œæ•´çš„åœ–ç‰‡ï¼</p>
            <button class="modal-btn" onclick="resetGame()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        // ç‹€æ…‹è®Šæ•¸
        const state = {
            rows: 4,
            cols: 4,
            pieces: [],
            currentImage: '',
            isDragging: false,
            draggedEl: null,
            selectedEl: null // For Click-to-Swap mode
        };

        // DOM å…ƒç´ 
        const board = document.getElementById('puzzle-board');
        const levelSelect = document.getElementById('level-select');
        const imageUpload = document.getElementById('image-upload');
        const restartBtn = document.getElementById('restart-btn');
        const peekBtn = document.getElementById('peek-btn');
        const modal = document.getElementById('win-modal');

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            state.currentImage = levelSelect.value;
            loadImage(state.currentImage);
        });

        // ç›£è½é—œå¡åˆ‡æ›
        levelSelect.addEventListener('change', (e) => {
            state.currentImage = e.target.value;
            loadImage(state.currentImage);
        });

        // ç›£è½åœ–ç‰‡ä¸Šå‚³
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    state.currentImage = event.target.result;
                    loadImage(state.currentImage);
                }
                reader.readAsDataURL(file);
            }
        });

        // ç›£è½é‡æ–°é–‹å§‹
        restartBtn.addEventListener('click', () => {
            shufflePieces();
            state.selectedEl = null; // é‡ç½®é¸å–ç‹€æ…‹
            updateSelectionVisuals();
        });

        // å·çœ‹åŠŸèƒ½ (æ”¯æ´æ»‘é¼ æŒ‰ä½ èˆ‡ è§¸æ§æŒ‰ä¸‹)
        const startPeek = () => board.classList.add('peeking');
        const endPeek = () => board.classList.remove('peeking');

        peekBtn.addEventListener('mousedown', startPeek);
        peekBtn.addEventListener('mouseup', endPeek);
        peekBtn.addEventListener('mouseleave', endPeek);
        peekBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPeek(); });
        peekBtn.addEventListener('touchend', endPeek);

        // æ ¸å¿ƒé‚è¼¯ï¼šè¼‰å…¥åœ–ç‰‡ä¸¦è¨ˆç®—ç¶²æ ¼
        function loadImage(src) {
            const img = new Image();
            img.src = src;
            img.onload = () => {
                // 1. è¨ˆç®—æ¯”ä¾‹èˆ‡ç¶²æ ¼
                const aspectRatio = img.width / img.height;
                let rows, cols;

                // ç›®æ¨™ç¸½ç‰‡æ•¸ç´„ 12-16 ç‰‡
                if (aspectRatio >= 1.3) {
                    // å¯¬åœ–
                    cols = 4; rows = 3;
                } else if (aspectRatio <= 0.7) {
                    // é•·åœ–
                    cols = 3; rows = 4;
                } else {
                    // æ¥è¿‘æ–¹å½¢
                    cols = 4; rows = 4;
                }

                state.rows = rows;
                state.cols = cols;

                // 2. è¨­å®š CSS è®Šæ•¸
                document.documentElement.style.setProperty('--rows', rows);
                document.documentElement.style.setProperty('--cols', cols);
                document.documentElement.style.setProperty('--aspect-ratio', `${img.width} / ${img.height}`);
                document.documentElement.style.setProperty('--bg-image', `url(${src})`);

                // 3. ç”Ÿæˆæ‹¼åœ–
                createPuzzle();
            };
        }

        // ç”Ÿæˆæ‹¼åœ–å¡Š
        function createPuzzle() {
            board.innerHTML = '';
            state.pieces = [];
            
            const { rows, cols } = state;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const index = r * cols + c;
                    const piece = document.createElement('div');
                    piece.classList.add('piece');
                    piece.draggable = true;
                    
                    // è¨­å®šæ­¤å¡Šçš„æ­£ç¢º ID
                    piece.dataset.correctIndex = index;
                    
                    // è¨ˆç®—èƒŒæ™¯åœ–ä½ç½® (Background Position)
                    // å…¬å¼: 0% åˆ° 100% åˆ†ä½ˆåœ¨ (cols-1) å€‹é–“éš”ä¸­
                    const xPct = cols > 1 ? (c / (cols - 1)) * 100 : 0;
                    const yPct = rows > 1 ? (r / (rows - 1)) * 100 : 0;
                    
                    piece.style.setProperty('--pos-x', `${xPct}%`);
                    piece.style.setProperty('--pos-y', `${yPct}%`);

                    // åŠ å…¥äº‹ä»¶ç›£è½
                    addInteractionListeners(piece);

                    state.pieces.push(piece);
                    board.appendChild(piece);
                }
            }

            // æ‰“äº‚æ‹¼åœ–
            setTimeout(shufflePieces, 100);
        }

        // æ‰“äº‚æ‹¼åœ– (Fisher-Yates Shuffle on DOM elements)
        function shufflePieces() {
            // å¾ DOM ç§»é™¤æ‰€æœ‰å…ƒç´ 
            state.pieces.forEach(p => p.remove());
            
            // æ‰“äº‚é™£åˆ—
            for (let i = state.pieces.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.pieces[i], state.pieces[j]] = [state.pieces[j], state.pieces[i]];
            }

            // é‡æ–°æ’å…¥ DOM
            state.pieces.forEach(p => board.appendChild(p));
            
            // æª¢æŸ¥æ˜¯å¦å¤ªå¹¸é‹ç›´æ¥å®Œæˆ (æ¥µä½æ©Ÿç‡)ï¼Œè‹¥å®Œæˆå‰‡å†æ´—ä¸€æ¬¡ï¼Œé¿å…å‰›é–‹å§‹å°±è´äº†
            if (checkWin(true)) {
                shufflePieces();
            }
        }

        // åŠ å…¥äº’å‹•ç›£è½ (Drag & Drop + Click to Swap)
        function addInteractionListeners(piece) {
            // --- Desktop: Drag & Drop ---
            piece.addEventListener('dragstart', handleDragStart);
            piece.addEventListener('dragover', handleDragOver);
            piece.addEventListener('dragenter', handleDragEnter);
            piece.addEventListener('dragleave', handleDragLeave);
            piece.addEventListener('drop', handleDrop);
            piece.addEventListener('dragend', handleDragEnd);

            // --- Mobile/Click: Click to Swap ---
            piece.addEventListener('click', handleClick);
        }

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            state.draggedEl = this;
            this.style.opacity = '0.4';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault(); // å…è¨± Drop
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== state.draggedEl) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            this.classList.remove('drag-over');

            if (state.draggedEl && state.draggedEl !== this) {
                swapElements(state.draggedEl, this);
                checkWin();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            state.draggedEl = null;
            // æ¸…é™¤æ‰€æœ‰ hover æ¨£å¼
            document.querySelectorAll('.piece').forEach(p => p.classList.remove('drag-over'));
        }

        // --- Click/Touch Handlers ---
        function handleClick(e) {
            // å¦‚æœæ­£åœ¨æ‹–æ›³ï¼Œå¿½ç•¥é»æ“Š
            if (state.draggedEl) return;

            const clickedEl = this;

            if (!state.selectedEl) {
                // ç¬¬ä¸€æ¬¡é»é¸
                state.selectedEl = clickedEl;
                updateSelectionVisuals();
            } else {
                // ç¬¬äºŒæ¬¡é»é¸
                if (state.selectedEl !== clickedEl) {
                    // äº¤æ›
                    swapElements(state.selectedEl, clickedEl);
                    state.selectedEl = null; // é‡ç½®
                    updateSelectionVisuals();
                    checkWin();
                } else {
                    // é»é¸åŒä¸€å€‹ -> å–æ¶ˆé¸å–
                    state.selectedEl = null;
                    updateSelectionVisuals();
                }
            }
        }

        function updateSelectionVisuals() {
            document.querySelectorAll('.piece').forEach(p => p.classList.remove('selected'));
            if (state.selectedEl) {
                state.selectedEl.classList.add('selected');
            }
        }

        // äº¤æ›å…©å€‹ DOM å…ƒç´ çš„ä½ç½®
        function swapElements(el1, el2) {
            // å»ºç«‹ä¸€å€‹æš«å­˜çš„ text node ä½œç‚ºæ¨™è¨˜ä½ç½®
            const temp = document.createTextNode('');
            el1.after(temp);
            el2.after(el1);
            temp.after(el2);
            temp.remove();
        }

        // æª¢æŸ¥å‹åˆ©æ¢ä»¶
        function checkWin(silent = false) {
            const currentPieces = Array.from(board.children);
            let isWin = true;

            for (let i = 0; i < currentPieces.length; i++) {
                // æª¢æŸ¥ DOM é †åºæ˜¯å¦ç­‰æ–¼æ­£ç¢ºçš„ index
                if (parseInt(currentPieces[i].dataset.correctIndex) !== i) {
                    isWin = false;
                    break;
                }
            }

            if (isWin && !silent) {
                setTimeout(() => {
                    modal.classList.add('active');
                    // æ’­æ”¾ä¸€é»æ…¶ç¥ç‰¹æ•ˆ (å¯é¸)
                }, 200);
            }
            return isWin;
        }

        // Modal æŒ‰éˆ•ä½¿ç”¨çš„é‡ç½®å‡½å¼
        window.resetGame = function() {
            modal.classList.remove('active');
            shufflePieces();
        }

    </script>
</body>
</html>